## 实施计划

### 模块 1：新建 `lib/widgets/ai_fix_chat_dialog.dart`
创建独立的有状态对话弹窗组件 `AIFixChatDialog`：
- **参数**：`initialSelectedText` (原始选中文本)
- **状态**：
  - `chatHistory` - 对话历史记录
  - `currentDraft` - AI 最新草稿
  - `isLoading` - 加载状态
- **UI 布局**：
  - 顶部：折叠面板显示原始文本（只读对照）
  - 中部：大 TextField 显示当前草稿（可微调）
  - 对话区：ListView 展示历史对话
  - 底部输入：TextField + 发送按钮
  - 底部操作栏：【取消】+【应用并替换】（醒目样式）
- **返回**：`Navigator.pop(context, currentDraft)` 返回最终草稿

### 模块 2：修改 `lib/pages/home_page.dart`
在编辑器 TextField 中实现右键菜单拦截：
- 添加 `contextMenuBuilder` 参数
- 新增【✨ AI 局部调优】菜单项
- 实现选区获取 → 弹窗呼出 → 精准替换闭环
- 使用 `TextSelection` 处理边界情况

### 模块 3：修改 `lib/pages/settings_page.dart`
设置页交互优化：
- 废弃 `SegmentedButton`，改用 `DropdownButtonFormField<String>`
- 选项：`openai` (OpenAI 兼容模式)、`gemini` (Gemini 原生模式)
- 数据隔离：OpenAI 和 Gemini 的 API Key 独立存储
- 切换提供商时动态刷新表单内容

### 模块 4：修改 `lib/services/llm_service.dart`
新增连续对话接口：
- 新增 `chatFixText()` 方法
- 参数：`originalText`, `history`, `newInstruction`, `systemPrompt`
- 组装对话上下文发送给大模型
- Prompt 严格约束：仅输出纯文本，禁止 Markdown 代码块包裹

### 模块 5：修改 `lib/services/settings_service.dart`
支持双提供商独立存储：
- 新增 `openai_api_key` 和 `gemini_api_key` 独立 Key
- 切换提供商时自动加载对应 API Key
- 保持向后兼容现有数据